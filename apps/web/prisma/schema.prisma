// Enhanced Prisma schema incorporating ProofOfFit-2 improvements
// This maintains backward compatibility while adding new features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enhanced enums from ProofOfFit-2
enum Plan {
  FREE
  PRO
  PREMIUM
}

enum ProofKind {
  link
  file
  repo
  case
}

enum ApplicationStatus {
  draft
  submitted
  review
  interview
  offer
  rejected
}

enum SignalSource {
  self
  assessment
  review
}

enum PackageStatus {
  draft
  active
  revoked
  expired
}

enum ConsentStatus {
  active
  revoked
  expired
}

enum AutoApplyAction {
  submitted
  failed
  skipped
  duplicate
}

// Core tenant and user management
model Tenant {
  id        String   @id @default(cuid())
  name      String
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  candidateProfiles CandidateProfile[]
  employerIntakes   EmployerIntake[]
  slates           Slate[]
  applications     Application[]
  consents         Consent[]
  actionLogs       ActionLog[]
  organizations    Organization[]

  @@map("tenants")
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  email     String   @unique
  role      String   @default("candidate") // candidate, employer, admin
  locale    String   @default("en")
  plan      Plan     @default(FREE)
  stripeCustomerId String?
  stripeSubscriptionId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  candidateProfile CandidateProfile?
  applications     Application[]
  consents         Consent[]
  proofs           Proof[]
  auditLinks       AuditLink[]
  applicationPackages ApplicationPackage[]
  autoApplyRules   AutoApplyRule[]
  signals          Signal[]

  @@map("users")
}

// Enhanced Candidate profile with rich metadata
model CandidateProfile {
  id            String   @id @default(cuid())
  tenantId      String
  userId        String   @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  headline      String?
  linkedinUrl   String?
  githubUrl     String?
  portfolioUrl  String?
  location      String?
  preferences   Json     @default("{}")
  contactPolicy Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentials  Credential[]
  bullets      Bullet[]
  artifacts    Artifact[]
  applications Application[]

  @@map("candidate_profiles")
}

model Credential {
  id          String   @id @default(cuid())
  candidateId String
  type        String   // degree, certification, license, etc.
  issuer      String
  issuedOn    DateTime?
  verified    Boolean  @default(false)
  docUrl      String?

  // Relations
  candidate CandidateProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("credentials")
}

model Bullet {
  id          String   @id @default(cuid())
  candidateId String
  text        String
  tags        Json     @default("{}") // {criterion, evidence_type, metric?, scope?, tool?, link?}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  candidate CandidateProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("bullets")
}

model Artifact {
  id          String   @id @default(cuid())
  candidateId String
  title       String
  url         String
  type        String   // resume, portfolio, cover_letter, etc.
  createdAt   DateTime @default(now())

  // Relations
  candidate CandidateProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("artifacts")
}

// Job and employer data
model Job {
  id           String   @id @default(cuid())
  externalId   String?
  source       String   // usajobs, reliefweb, greenhouse, lever, etc.
  org          String
  title        String
  location     String
  workType     String   // remote, hybrid, onsite
  compensationRange String?
  pay          Json?    @default("{}")
  description  String
  requirements Json     @default("{}") // {must_have: [], preferred: []}
  constraints  Json     @default("{}") // {license?, clearance?, language: []}
  tos          Json     @default("{}") // {allowed: boolean, captcha: boolean, notes}
  skills       String[]
  orgId        String?
  createdById  String?
  isActive     Boolean  @default(true)
  fetchedAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organization   Organization?   @relation(fields: [orgId], references: [id], onDelete: SetNull)
  employerIntakes EmployerIntake[]
  applications    Application[]
  slates          Slate[]

  @@map("jobs")
}

model EmployerIntake {
  id               String   @id @default(cuid())
  tenantId         String
  jobRef           String
  mustHave         Json     @default("[]")
  preferred        Json     @default("[]")
  preferenceOrder  Json     @default("[]")
  weights          Json     @default("{}")
  constraints      Json     @default("{}")
  terms            Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobRef], references: [id], onDelete: Cascade)
  slates Slate[]

  @@map("employer_intakes")
}

model Slate {
  id         String   @id @default(cuid())
  tenantId   String
  employerId String
  jobRef     String
  weights    Json     @default("{}")
  candidates Json     @default("[]") // [{candidate_id, fit: 0..1, explanations: [], status}]
  auditUrl   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobRef], references: [id], onDelete: Cascade)
  intake EmployerIntake @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@map("slates")
}

model Application {
  id          String            @id @default(cuid())
  tenantId    String
  jobId       String
  userId      String
  status      ApplicationStatus @default(draft)
  coverLetter String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job                Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidateProfile   CandidateProfile    @relation(fields: [userId], references: [userId], onDelete: Cascade, map: "applications_candidate_profile_fkey")
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade, map: "applications_user_fkey")
  targetProofWeights TargetProofWeight[]
  consentLedger      ConsentLedgerEntry[]

  @@map("applications")
}

// Criteria graph for matching
model CriteriaNode {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String
  parentId  String?
  synonyms  String[] @default([])
  meta      Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Self-referential relation
  parent   CriteriaNode?  @relation("CriteriaHierarchy", fields: [parentId], references: [id])
  children CriteriaNode[] @relation("CriteriaHierarchy")

  @@map("criteria_nodes")
}

// Vector embeddings for semantic search
model Embedding {
  id       String @id @default(cuid())
  objType  String // job, bullet, criteria
  objId    String
  vector   Unsupported("vector(768)") // pgvector extension
  createdAt DateTime @default(now())

  @@unique([objType, objId])
  @@map("embeddings")
}

// Consent and privacy management (enhanced version below)

model GiftCode {
  id                    String   @id @default(uuid()) @db.Uuid
  code                  String   @unique
  months                Int
  currency              String   @default("USD")
  amountCents           Int      @map("amount_cents")
  status                String   @default("active")
  sponsorUserId         String?  @map("sponsor_user_id") @db.Uuid
  recipientEmail        String?  @map("recipient_email")
  message               String?
  redeemedBy            String?  @map("redeemed_by") @db.Uuid
  redeemedAt            DateTime? @map("redeemed_at")
  expiresAt             DateTime  @default(dbgenerated("now() + interval '12 months'")) @map("expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  stripeCouponId        String?   @map("stripe_coupon_id")
  stripePromotionCodeId String?   @map("stripe_promotion_code_id")
  stripeSubscriptionId  String?   @map("stripe_subscription_id")

  @@map("gift_codes")
}

model SponsorPool {
  id            String   @id @default(uuid()) @db.Uuid
  sponsorUserId String   @map("sponsor_user_id") @db.Uuid
  amountCents   Int      @map("amount_cents")
  currency      String   @default("USD")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("sponsor_pool")
}

// Policy sources and ToS compliance
model PolicySource {
  id        String   @id @default(cuid())
  domain    String   @unique
  allowed   Boolean  @default(false)
  captcha   Boolean  @default(false)
  notes     String?
  version   String   @default("1.0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("policy_sources")
}

// Immutable action log with hash chaining
model ActionLog {
  id          BigInt   @id @default(autoincrement())
  tenantId    String
  actorType   String   // user, system, api
  actorId     String
  action      String   // create, update, delete, apply, etc.
  objType     String   // job, profile, slate, etc.
  objId       String
  payloadHash Bytes    // SHA256 hash of payload
  prevHash    Bytes?   // Previous hash in chain
  hash        Bytes    // Current hash: SHA256(prevHash + payloadHash + timestamp)
  ts          DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("action_log")
}

// Target model for job targeting and proof organization
model Target {
  id           String   @id @default(cuid())
  userId       String
  title        String
  role         String
  companyHint  String?
  layout       String   @default("REPORT") // REPORT, PORTFOLIO, ONEPAGER
  rubricJson   Json     @default("{}")
  jdSnapshot   String?
  fitScore     Float?
  lastAnalyzedAt DateTime?
  isDeleted    Boolean  @default(false)
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  weights      TargetProofWeight[]
  auditLinks   AuditLink[]

  @@map("targets")
}

// Enhanced Proof model (formerly Evidence/Artifact)
model Proof {
  id          String    @id @default(cuid())
  userId      String
  kind        ProofKind
  title       String
  url         String?
  description String?
  skills      String[]
  impact      String?
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetProofWeights  TargetProofWeight[]
  auditLinkProofs     AuditLinkProof[]
  signals             Signal[]

  @@map("proofs")
}

// Enhanced TargetProofWeight - weighted proof linking
model TargetProofWeight {
  id            String   @id @default(cuid())
  applicationId String
  proofId       String
  weight        Decimal  @default(1.00) @db.Decimal(5, 2)
  notes         String?
  createdAt     DateTime @default(now())

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade, map: "target_proof_weights_application_fkey")
  proof       Proof       @relation(fields: [proofId], references: [id], onDelete: Cascade)
  target      Target      @relation(fields: [applicationId], references: [id], onDelete: Cascade, map: "target_proof_weights_target_fkey")

  @@unique([applicationId, proofId])
  @@map("target_proof_weights")
}

// Enhanced AuditLinks - shareable portfolio links
model AuditLink {
  id           String    @id @default(cuid())
  userId       String
  slug         String    @unique
  title        String
  description  String?
  isActive     Boolean   @default(true)
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLinkProofs AuditLinkProof[]
  target          Target            @relation(fields: [userId], references: [id], onDelete: Cascade, map: "audit_links_target_fkey")

  @@map("audit_links")
}

// NEW: AuditLinkProofs - many-to-many relationship
model AuditLinkProof {
  id          String @id @default(cuid())
  auditLinkId String
  proofId     String
  order       Int    @default(0)

  // Relations
  auditLink AuditLink @relation(fields: [auditLinkId], references: [id], onDelete: Cascade)
  proof     Proof     @relation(fields: [proofId], references: [id], onDelete: Cascade)

  @@unique([auditLinkId, proofId])
  @@map("audit_link_proofs")
}

// Enhanced Signals model
model Signal {
  id        String       @id @default(cuid())
  userId    String
  name      String
  level     Int
  source    SignalSource
  proofId   String?
  createdAt DateTime     @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  proof Proof? @relation(fields: [proofId], references: [id], onDelete: SetNull)

  @@map("signals")
}

// NEW: Application Packages - versioned application bundles
model ApplicationPackage {
  id                String        @id @default(cuid())
  userId            String
  version           String
  resumeUrl         String?
  coverLetterTemplate String?
  files             String[]
  contentHash       String
  status            PackageStatus @default(draft)
  createdAt         DateTime      @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  consents Consent[]

  @@map("application_packages")
}

// Enhanced Consents model
model Consent {
  id                String        @id @default(cuid())
  tenantId          String
  userId            String
  packageId         String
  scopeJson         String
  signatureBlob     String
  signatureProvider String        @default("canvas")
  validFrom         DateTime      @default(now())
  validTo           DateTime?
  status            ConsentStatus @default(active)
  createdAt         DateTime      @default(now())
  revokedAt         DateTime?

  // Relations
  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  package  ApplicationPackage  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  ledger   ConsentLedgerEntry[]

  @@map("consents")
}

// NEW: Consent Ledger - immutable audit trail
model ConsentLedgerEntry {
  id                String         @id @default(cuid())
  userId            String
  packageId         String
  consentId         String
  jobId             String?
  action            AutoApplyAction
  timestamp         DateTime       @default(now())
  applyPayloadHash  String?
  previousHash      String?
  errorMessage      String?
  metadata          String?

  // Relations
  consent Consent @relation(fields: [consentId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@map("consent_ledger")
}

// NEW: Auto-Apply Rules
model AutoApplyRule {
  id              String    @id @default(cuid())
  userId          String
  name            String
  scopeJson       String
  weeklyCap       Int       @default(5)
  cooldownSeconds Int       @default(86400) // 24 hours
  enabled         Boolean   @default(false)
  lastRunAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auto_apply_rules")
}

// Organizations for employers
model Organization {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  domain    String?
  website   String?
  logoUrl   String?
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jobs   Job[]

  @@map("organizations")
}

// Analytics events for tracking user behavior
model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventType String
  userId    String?
  targetId  String?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@map("analytics_events")
}

// Claim generation logs for AI-generated content
model ClaimGenerationLog {
  id              String   @id @default(cuid())
  userId          String
  targetId        String
  prompt          String
  claim           String
  outputHash      String
  allowedProofIds String[] @default([])
  createdAt       DateTime @default(now())

  @@map("claim_generation_logs")
}

// System health check table for monitoring
model SystemHealth {
  id        String   @id @default(cuid())
  status    String   @default("healthy") // healthy, degraded, unhealthy
  message   String?
  timestamp DateTime @default(now())
  metadata  Json     @default("{}")

  @@map("system_health")
}

// Audit events for compliance tracking
model AuditEvent {
  id          String   @id @default(cuid())
  eventType   String   // login, data_access, data_export, data_deletion, etc.
  userId      String?
  tenantId    String?
  action      String   // create, read, update, delete, export, etc.
  resource    String   // user, profile, application, etc.
  resourceId  String?
  metadata    Json     @default("{}")
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  @@map("audit_events")
}
